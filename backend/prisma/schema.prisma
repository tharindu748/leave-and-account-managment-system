// generator client {
//   provider = "prisma-client-js"
// }

// datasource db {
//   provider = "postgresql"
//   url      = env("DATABASE_URL")
// }

// model User {
//   id                 Int                  @id @default(autoincrement())
//   email              String               @unique
//   password           String
//   name               String
//   isAdmin            Boolean              @default(false)
//   createdAt          DateTime             @default(now())
//   updatedAt          DateTime             @updatedAt
//   refreshToken       String?
//   employeeId         String?              @unique @map("employee_id")
//   cardNumber         String?              @map("card_number")
//   validFrom          DateTime?            @map("valid_from")
//   validTo            DateTime?            @map("valid_to")
//   epfNo              String?              @map("epfNo")
//   nic                String?              @map("NIC")
//   jobPosition        String?              @map("jobPosition")
//   imagePath          String?
//   active             Boolean              @default(true)

//     // ✅ ADD THESE MISSING FIELDS
//   joinDate           DateTime?           @map("join_date")
//   address            String?

//   leaveRequests    Leave_request[] @relation("UserLeaveRequests")
//   approvedRequests Leave_request[] @relation("ApprovedRequests")

//   leaveBalances      Leave_balance[]
//   punches            Punch[]
//   attendanceDays     AttendanceDay[]

//   salaryConfigs    SalaryConfig[]
//   salaryRecords    SalaryRecord[]


//   @@map("users")
//   // SalaryConfig SalaryConfig[]
//   // SalaryRecord SalaryRecord[]
// }

// model Leave_request {
//   id          Int                  @id @default(autoincrement())
//   userId      Int
//   approvedBy  Int?
//   leaveType   LeaveType
//   status      LeaveStatus?         @default(PENDING)
//   reason      String?
//   // department  String?
//   requestedAt DateTime             @default(now())
//   approvedAt  DateTime?
//   rejectedAt  DateTime?
//   dates       Leave_request_date[]

//   user           User @relation("UserLeaveRequests", fields: [userId], references: [id], onDelete: Cascade)
//   approvedByUser User? @relation("ApprovedRequests", fields: [approvedBy], references: [id])

//   @@map("leave_requests")
// }

// model Leave_request_date {
//   id          Int           @id @default(autoincrement())
//   requestId   Int
//   leaveDate   DateTime
//   isHalfDay   Boolean       @default(false)
//   halfdayType HalfdayType?
//   request     Leave_request @relation(fields: [requestId], references: [id], onDelete: Cascade)

//   @@map("leave_request_dates")
// }

// model Leave_balance {
//   id        Int       @id @default(autoincrement())
//   userId    Int
//   year      Int
//   leaveType LeaveType
//   balance   Float

//   user User @relation(fields: [userId], references: [id], onDelete: Cascade)

//   @@unique([userId, year, leaveType])
//   @@map("leave_balances")
// }

// model Leave_policy {
//   leaveType      LeaveType @id
//   defaultBalance Float

//   @@map("leave_policies")
// }

// model SyncHistory {
//   id           Int      @id @default(autoincrement())
//   syncTime     DateTime @default(now()) @map("sync_time")
//   totalUsers   Int      @map("total_users")
//   newUsers     Int      @map("new_users")
//   updatedUsers Int      @map("updated_users")
//   status       String

//   @@map("sync_history")
// }

// model Punch {
//   id Int                        @id @default(autoincrement())
//   employeeId String             @map("employee_id")
//   eventTime DateTime            @map("event_time") @db.Timestamptz(0)
//   correctEventTime DateTime?    @map("correct_event_time") @db.Timestamptz(0) // NEW (nullable for backfill)
//   direction Direction
//   source Source
//   note String?
//   createdBy String?             @map("created_by")
//   createdAt DateTime            @default(now()) @map("created_at") @db.Timestamptz(0)
//   deletedAt DateTime?           @map("deleted_at") @db.Timestamptz(0)
//   directionCorrected Boolean    @default(false) @map("direction_corrected")
//   originalDirection Direction?  @map("original_direction")
//   correctedBy String?           @map("corrected_by")
//   correctionNote String?        @map("correction_note")
//   correctedAt DateTime?         @map("corrected_at") @db.Timestamptz(0)

//   user User                     @relation(fields: [employeeId], references: [employeeId], onDelete: Cascade)
//   @@unique([employeeId, eventTime, direction, source])
//   @@index([employeeId, eventTime])
//   @@index([employeeId, correctEventTime])
//   @@map("punches")
// }

// model AttendanceDay {
//   employeeId        String           @map("employee_id")
//   workDate          DateTime         @map("work_date")
//   startTime         String?          @map("start_time")
//   firstIn           String?          @map("first_in")
//   lastOut           String?          @map("last_out")
//   workedSeconds     Int              @default(0) @map("worked_seconds")
//   notWorkingSeconds Int              @default(0) @map("not_working_seconds")
//   overtimeSeconds   Int              @default(0) @map("overtime_seconds")
//   hadManual         Boolean          @default(false) @map("had_manual")
//   status            AttendanceStatus @default(OK)
//   calculatedAt      DateTime         @default(now()) @map("calculated_at")

//   user User @relation(fields: [employeeId], references: [employeeId], onDelete: Cascade)

//   @@id([employeeId, workDate])
//   @@index([workDate])
//   @@map("attendance_day")
// }

// model DeviceConfig {
//   id               Int       @id
//   ip               String
//   username         String
//   passwordEnc      String
//   lastEventTime    String?
//   authFailedAt     DateTime? // When auth last failed
//   authFailureCount Int       @default(0) // Number of consecutive failures
//   createdAt        DateTime  @default(now())
//   updatedAt        DateTime  @updatedAt

//   @@map("device_configs")
// }

// model AttendanceConfig {
//   id          Int      @id @default(autoincrement())
//   workStart   DateTime
//   workEnd     DateTime
//   otEnd       DateTime
//   earlyStart  DateTime
//   createdAt   DateTime @default(now())
//   updatedAt   DateTime @updatedAt

//   @@map("attendance_config")
// }


// enum LeaveType {
//   ANNUAL
//   CASUAL
// }

// enum LeaveStatus {
//   PENDING
//   APPROVED
//   REJECTED
//   CANCELLED
// }

// enum HalfdayType {
//   MORNING
//   AFTERNOON
// }

// enum Direction {
//   IN
//   OUT
// }

// enum Source {
//   device
//   manual
// }

// enum AttendanceStatus {
//   OK
//   ABSENT
//   PARTIAL
//   MANUAL
// }
// /////// i add

// // In schema.prisma - add otRate to SalaryConfig if needed
// model SalaryConfig {
//   id           Int      @id @default(autoincrement())
//   userId       Int
//   basicSalary  Float
//   otRate       Float?   @default(0)  // Add this line if you want to store OT rate
//   allowance    Float?   @default(0)
//   deduction    Float?   @default(0)
//   effectiveFrom DateTime @default(now())
//   user User @relation(fields: [userId], references: [id], onDelete: Cascade)

//   @@map("salary_config")
// }

// model SalaryRecord {
//   id          Int      @id @default(autoincrement())
//   userId      Int
//   month       Int
//   year        Int
//   basicSalary Float
//   totalLeave  Int       @default(0)
//   leaveDeductions Float @default(0)
//   overtimePay Float     @default(0)
//   netSalary   Float
//   generatedAt DateTime  @default(now())

//   user User @relation(fields: [userId], references: [id], onDelete: Cascade)

//   @@unique([userId, month, year])
//   @@map("salary_records")
// }
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 Int                  @id @default(autoincrement())
  email              String               @unique
  password           String
  name               String
  isAdmin            Boolean              @default(false)
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  refreshToken       String?
  employeeId         String?              @unique @map("employee_id")
  cardNumber         String?              @map("card_number")
  validFrom          DateTime?            @map("valid_from")
  validTo            DateTime?            @map("valid_to")
  epfNo              String?              @map("epfNo")
  nic                String?              @map("NIC")
  jobPosition        String?              @map("jobPosition")
  imagePath          String?
  active             Boolean              @default(true)

  // ✅ ADD THESE MISSING FIELDS
  joinDate           DateTime?            @map("join_date")
  address            String?

  leaveRequests      Leave_request[]      @relation("UserLeaveRequests")
  approvedRequests   Leave_request[]      @relation("ApprovedRequests")
  leaveBalances      Leave_balance[]
  punches            Punch[]
  attendanceDays     AttendanceDay[]
  salaryConfigs      SalaryConfig[]
  salaryRecords      SalaryRecord[]
  salarySetups       SalarySetup[]        // NEW: Comprehensive salary setups

  @@map("users")
  PaymentRecord PaymentRecord[]
}

model Leave_request {
  id          Int                  @id @default(autoincrement())
  userId      Int
  approvedBy  Int?
  leaveType   LeaveType
  status      LeaveStatus?         @default(PENDING)
  reason      String?
  requestedAt DateTime             @default(now())
  approvedAt  DateTime?
  rejectedAt  DateTime?
  dates       Leave_request_date[]

  user           User @relation("UserLeaveRequests", fields: [userId], references: [id], onDelete: Cascade)
  approvedByUser User? @relation("ApprovedRequests", fields: [approvedBy], references: [id])

  @@map("leave_requests")
}

model Leave_request_date {
  id          Int           @id @default(autoincrement())
  requestId   Int
  leaveDate   DateTime
  isHalfDay   Boolean       @default(false)
  halfdayType HalfdayType?
  request     Leave_request @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@map("leave_request_dates")
}

model Leave_balance {
  id        Int       @id @default(autoincrement())
  userId    Int
  year      Int
  leaveType LeaveType
  balance   Float

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, year, leaveType])
  @@map("leave_balances")
}

model Leave_policy {
  leaveType      LeaveType @id
  defaultBalance Float

  @@map("leave_policies")
}

model SyncHistory {
  id           Int      @id @default(autoincrement())
  syncTime     DateTime @default(now()) @map("sync_time")
  totalUsers   Int      @map("total_users")
  newUsers     Int      @map("new_users")
  updatedUsers Int      @map("updated_users")
  status       String

  @@map("sync_history")
}

model Punch {
  id Int                        @id @default(autoincrement())
  employeeId String             @map("employee_id")
  eventTime DateTime            @map("event_time") @db.Timestamptz(0)
  correctEventTime DateTime?    @map("correct_event_time") @db.Timestamptz(0)
  direction Direction
  source Source
  note String?
  createdBy String?             @map("created_by")
  createdAt DateTime            @default(now()) @map("created_at") @db.Timestamptz(0)
  deletedAt DateTime?           @map("deleted_at") @db.Timestamptz(0)
  directionCorrected Boolean    @default(false) @map("direction_corrected")
  originalDirection Direction?  @map("original_direction")
  correctedBy String?           @map("corrected_by")
  correctionNote String?        @map("correction_note")
  correctedAt DateTime?         @map("corrected_at") @db.Timestamptz(0)

  user User                     @relation(fields: [employeeId], references: [employeeId], onDelete: Cascade)
  @@unique([employeeId, eventTime, direction, source])
  @@index([employeeId, eventTime])
  @@index([employeeId, correctEventTime])
  @@map("punches")
}

model AttendanceDay {
  employeeId        String           @map("employee_id")
  workDate          DateTime         @map("work_date")
  startTime         String?          @map("start_time")
  firstIn           String?          @map("first_in")
  lastOut           String?          @map("last_out")
  workedSeconds     Int              @default(0) @map("worked_seconds")
  notWorkingSeconds Int              @default(0) @map("not_working_seconds")
  overtimeSeconds   Int              @default(0) @map("overtime_seconds")
  hadManual         Boolean          @default(false) @map("had_manual")
  status            AttendanceStatus @default(OK)
  calculatedAt      DateTime         @default(now()) @map("calculated_at")

  user User @relation(fields: [employeeId], references: [employeeId], onDelete: Cascade)

  @@id([employeeId, workDate])
  @@index([workDate])
  @@map("attendance_day")
}

model DeviceConfig {
  id               Int       @id
  ip               String
  username         String
  passwordEnc      String
  lastEventTime    String?
  authFailedAt     DateTime?
  authFailureCount Int       @default(0)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@map("device_configs")
}

model AttendanceConfig {
  id          Int      @id @default(autoincrement())
  workStart   DateTime
  workEnd     DateTime
  otEnd       DateTime
  earlyStart  DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("attendance_config")
}

// NEW: Comprehensive Salary Setup Model
model SalarySetup {
  id                    Int      @id @default(autoincrement())
  userId                Int
  basicSalary           Float
  otRate                Float?   @default(0)
  
  // Allowances
  regulatoryAllowance   Float?   @default(0)
  tasksAllowance1       Float?   @default(0)
  tasksAllowance2       Float?   @default(0)
  tasksAllowance3       Float?   @default(0)
  tasksAllowance4       Float?   @default(0)
  tasksAllowance5       Float?   @default(0)
  
  // Per Day Rates
  perDayRate            Float?   @default(0)
  latePerDayRate        Float?   @default(0)
  
  // Payment Method
  paymentMethod         String?   @default("cash")
  paymentFrequency      String?   @default("monthly")
  salaryDaysCalculation String?   @default("calendar")
  
  // Compliance Settings
  epfPercentage         Float?    @default(0)
  etfPercentage         Float?    @default(0)
  taxPercentage         Float?    @default(0)
  
  effectiveFrom         DateTime  @default(now())
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("salary_setups")
}

// Existing Simple Salary Config (Keep for backward compatibility)
model SalaryConfig {
  id           Int      @id @default(autoincrement())
  userId       Int
  basicSalary  Float
  otRate       Float?   @default(0)
  allowance    Float?   @default(0)
  deduction    Float?   @default(0)
  effectiveFrom DateTime @default(now())
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("salary_config")
}

model SalaryRecord {
  id          Int      @id @default(autoincrement())
  userId      Int
  month       Int
  year        Int
  basicSalary Float
  totalLeave  Int       @default(0)
  leaveDeductions Float @default(0)
  overtimePay Float     @default(0)
  netSalary   Float
  generatedAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, month, year])
  @@map("salary_records")
  SalaryComponent SalaryComponent[]
  PaymentRecord PaymentRecord[]
}

// NEW: Salary Components Breakdown
model SalaryComponent {
  id          Int      @id @default(autoincrement())
  salaryRecordId Int
  componentType String   // basic, overtime, allowance, deduction, etc.
  description  String
  amount       Float
  percentage   Float?   @default(0)
  
  salaryRecord SalaryRecord @relation(fields: [salaryRecordId], references: [id], onDelete: Cascade)
  
  @@map("salary_components")
}

// NEW: Payment Records
model PaymentRecord {
  id              Int      @id @default(autoincrement())
  userId          Int
  salaryRecordId  Int?
  paymentDate     DateTime
  amount          Float
  paymentMethod   String
  referenceNumber String?
  status          PaymentStatus @default(PENDING)
  processedAt     DateTime?
  notes           String?
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  salaryRecord SalaryRecord? @relation(fields: [salaryRecordId], references: [id])
  
  @@map("payment_records")
}

enum LeaveType {
  ANNUAL
  CASUAL
  SICK
  MATERNITY
  PATERNITY
  UNPAID
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum HalfdayType {
  MORNING
  AFTERNOON
}

enum Direction {
  IN
  OUT
}

enum Source {
  device
  manual
}

enum AttendanceStatus {
  OK
  ABSENT
  PARTIAL
  MANUAL
  HOLIDAY
}

// NEW: Payment Status Enum
enum PaymentStatus {
  PENDING
  PROCESSED
  FAILED
  CANCELLED
}

// NEW: Payment Method Enum
enum PaymentMethod {
  CASH
  BANK_TRANSFER
  CHEQUE
  DIGITAL_WALLET
}